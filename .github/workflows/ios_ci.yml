name: Fastlane CI

on:
  pull_request:

jobs:
  build:
    runs-on: macos-15
    env:
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      DEV_TEAM_ID: ${{ secrets.DEV_TEAM_ID }}
      DEV_CODE_SIGN_IDENTITY: ${{ secrets.DEV_CODE_SIGN_IDENTITY }}
      APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      MATCH_KEYCHAIN_NAME: "ci.keychain-db"
      MATCH_REPO_URL: ${{ secrets.MATCH_REPO_URL }}

    steps:
      - name: ğŸ”„ Checkout source code
        uses: actions/checkout@v4

      - name: ğŸ“ Generate .env.ci from env
        working-directory: src/fastlane
        run: |
          echo "MATCH_PASSWORD=$MATCH_PASSWORD" > .env.ci
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> .env.ci
          echo "DEV_TEAM_ID=$DEV_TEAM_ID" >> .env.ci
          echo "DEV_CODE_SIGN_IDENTITY=$DEV_CODE_SIGN_IDENTITY" >> .env.ci
          echo "APP_IDENTIFIER=$APP_IDENTIFIER" >> .env.ci
          echo "APPLE_ID=$APPLE_ID" >> .env.ci
          echo "DISCORD_WEBHOOK_URL=$DISCORD_WEBHOOK_URL" >> .env.ci
          echo "MATCH_KEYCHAIN_NAME=$MATCH_KEYCHAIN_NAME" >> .env.ci
          echo "MATCH_REPO_URL=$MATCH_REPO_URL" >> .env.ci

      - name: ğŸ“± Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.0.app

      - name: ğŸ’« Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true

      - name: ğŸ“¦ Install dependencies
        working-directory: src
        run: bundle install

      - name: ğŸ›  Install Tuist
        run: brew install tuist

      - name: ğŸ” Create temporary keychain
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" $MATCH_KEYCHAIN_NAME
          security default-keychain -s $MATCH_KEYCHAIN_NAME
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $MATCH_KEYCHAIN_NAME
          security set-keychain-settings -t 3600 -u $MATCH_KEYCHAIN_NAME

      - name: ğŸ”’ Setup match certificates
        working-directory: src/fastlane
        run: |
          bundle exec fastlane match development \
            --type development \
            --keychain_name $MATCH_KEYCHAIN_NAME \
            --keychain_password "$KEYCHAIN_PASSWORD"
            
      - name: ğŸ§ª Run PR Checks (build + test)
        working-directory: src/fastlane
        run: bundle exec fastlane ci_pr --env ci

      - name: ğŸ§¹ Delete keychain
        if: always()
        run: security delete-keychain $MATCH_KEYCHAIN_NAME || true
