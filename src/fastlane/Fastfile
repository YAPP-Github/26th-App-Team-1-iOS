# fastlane/Fastfile
default_platform(:ios)

platform :ios do
  # Booket í”„ë¡œì íŠ¸ ì„¤ì • (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©)
  WORKSPACE_NAME     = "Booket.xcworkspace"
  MAIN_APP_SCHEME    = "Booket"
  WORKSPACE_SCHEME   = "Booket-Workspace"
  TEAM_ID            = ENV["DEVELOPMENT_TEAM"]
  BUNDLE_ID          = ENV["APP_IDENTIFIER"]
  APPLE_ID           = ENV["APPLE_ID"]
  DEVELOPER_NAME     = ENV["DEVELOPER_NAME"]

  # Fastlane dotenv í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš© ì‹œ í™˜ê²½ë³€ìˆ˜ ìë™ ë¡œë“œ
  # plugin 'dotenv'
  # before_all { dotenv }

  # ë™ì ìœ¼ë¡œ ì¸ì¦ì„œ ì´ë¦„ ìƒì„±
  def code_sign_identity_name
    "Apple Development: #{DEVELOPER_NAME} (#{TEAM_ID})"
  end

  # ëª¨ë“ˆ ë° í…ŒìŠ¤íŠ¸ ìŠ¤í‚´
  MODULE_SCHEMES = %w[BKCore BKData BKDesign BKDomain BKNetwork BKPresentation BKStorage]
  TEST_SCHEMES   = MODULE_SCHEMES.map { |s| "#{s}Test" }

  desc "Generate Tuist project"
  lane :generate do
    UI.message("ğŸ—ï¸ Generating Tuist project...")
    sh("cd .. && tuist generate")
    UI.success("âœ… Tuist project generated!")

    UI.message("ğŸ“‹ Available schemes:")
    sh("xcodebuild -workspace ../#{WORKSPACE_NAME} -list")
  end

  desc "Setup automatic code signing for main app"
  lane :setup_auto_signing do |options|
    identity = options[:identity] || code_sign_identity_name
    UI.message("ğŸ”§ Setting up automatic code signing with #{identity}...")

    project_path = File.expand_path("../Projects/Booket/Booket.xcodeproj")
    unless File.exist?(project_path)
      UI.error("âŒ Project file not found at: #{project_path}")
      UI.user_error!("Please check the project path")
    end

    update_code_signing_settings(
      use_automatic_signing: true,
      team_id: TEAM_ID,
      code_sign_identity: identity,
      targets: [MAIN_APP_SCHEME],
      path: project_path
    )
    UI.success("âœ… Automatic signing configured for Booket!")
  end

  desc "Setup manual code signing for main app"
  lane :setup_manual_signing do
    UI.message("ğŸ”§ Setting up manual code signing...")
    project_path = File.expand_path("../Projects/Booket/Booket.xcodeproj")

    update_code_signing_settings(
      use_automatic_signing: false,
      team_id: TEAM_ID,
      code_sign_identity: code_sign_identity_name,
      targets: [MAIN_APP_SCHEME],
      path: project_path
    )
    UI.success("âœ… Manual signing configured for Booket!")
  end

  desc "Generate and apply signing settings only (no build)"
  lane :generate_and_sign do
    generate
    setup_auto_signing(identity: code_sign_identity_name)
  end

  desc "Build all modules (without main app)"
  lane :build_modules do
    generate
    
    UI.message("ğŸ”¨ Building all BK modules...")
    
    MODULE_SCHEMES.each do |scheme|
      UI.message("Building #{scheme}...")
      
      xcodebuild(
        workspace: WORKSPACE_NAME,
        scheme: scheme,
        configuration: "Debug",
        build_settings: {
          "CODE_SIGN_IDENTITY" => "",
          "CODE_SIGNING_REQUIRED" => "NO"
        }
      )
    end
    
    UI.success("âœ… All modules built successfully!")
  end

  desc "Simple build with manual signing (testing)"
  lane :build_manual do
    generate
    setup_manual_signing
    
    UI.message("ğŸ”¨ Manual signing build test...")
    xcodebuild(
      workspace: WORKSPACE_NAME,
      scheme: MAIN_APP_SCHEME,
      configuration: "Debug",
      build_settings: {
        "CODE_SIGN_STYLE" => "Manual",
        "DEVELOPMENT_TEAM" => TEAM_ID,
        "CODE_SIGN_IDENTITY" => "Apple Development: DOYEON KIM (7L9YFLK4UM)",
        "ONLY_ACTIVE_ARCH" => "YES"
      }
    )
    
    UI.success("âœ… Manual build completed!")
  end

  desc "Build main app for development"
  lane :build_dev do
    # 1. í”„ë¡œì íŠ¸ ìƒì„±
    generate
    
    # 2. ê°œë°œìš© ì„œëª… ì„¤ì •
    setup_auto_signing(identity: "Apple Development")
    
    # 3. ë©”ì¸ ì•± ë¹Œë“œ
    UI.message("ğŸ”¨ Building Booket app for development...")
    build_app(
      workspace: WORKSPACE_NAME,
      scheme: MAIN_APP_SCHEME,           # "Booket" ìŠ¤í‚´ ì‚¬ìš©
      configuration: "Debug",
      export_method: "development",
      output_directory: "./builds/",
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        method: "development",
        teamID: TEAM_ID,
        signingStyle: "automatic",
        compileBitcode: false
      }
    )
    
    UI.success("âœ… Development build completed! Check ./builds/ folder")
  end

  desc "Build main app for App Store (ë‚˜ì¤‘ì— í•„ìš”ì‹œ ì‚¬ìš©)"
  lane :build_release do
    UI.message("âŒ Release build is not configured yet")
    UI.message("ğŸ’¡ Use 'build_dev' for development builds")
    UI.message("ğŸ“ To configure release builds, you need:")
    UI.message("  - Apple Distribution certificate")
    UI.message("  - App Store provisioning profile")
  end

  desc "Simple build without archive (for testing)"
  lane :build_simple do
    # 1. í”„ë¡œì íŠ¸ ìƒì„±
    generate
    
    # 2. ê°œë°œìš© ì„œëª… ì„¤ì • (Apple Development ì‚¬ìš©)
    setup_auto_signing(identity: "Apple Development")
    
    # 3. ê°„ë‹¨í•œ ë¹Œë“œ (archive ì—†ì´)
    UI.message("ğŸ”¨ Simple build test...")
    xcodebuild(
      workspace: WORKSPACE_NAME,
      scheme: MAIN_APP_SCHEME,
      configuration: "Debug",
      xcargs: "-allowProvisioningUpdates",  # ì¤‘ìš”: í”„ë¡œë¹„ì €ë‹ ì—…ë°ì´íŠ¸ í—ˆìš©
      build_settings: {
        "CODE_SIGN_STYLE" => "Automatic",
        "DEVELOPMENT_TEAM" => TEAM_ID,
        "ONLY_ACTIVE_ARCH" => "YES"
      }
    )
    
    UI.success("âœ… Simple build completed!")
  end

  desc "Run tests for all modules"
  lane :test_modules do
    generate
    
    UI.message("ğŸ§ª Running tests for all modules...")
    
    TEST_SCHEMES.each do |test_scheme|
      UI.message("Testing #{test_scheme}...")
      
      run_tests(
        workspace: WORKSPACE_NAME,
        scheme: test_scheme,
        devices: ["iPhone 15"],
        code_coverage: true,
        xcargs: "ONLY_ACTIVE_ARCH=YES"
      )
    end
    
    UI.success("âœ… All module tests passed!")
  end

  desc "Run tests for main app (if exists)"
  lane :test_app do
    generate
    
    UI.message("ğŸ§ª Testing main Booket app...")
    
    run_tests(
      workspace: WORKSPACE_NAME,
      scheme: MAIN_APP_SCHEME,
      devices: ["iPhone 15"],
      code_coverage: true,
      clean: true
    )
    
    UI.success("âœ… Main app tests passed!")
  end

  desc "Build workspace (all targets)"
  lane :build_workspace do
    generate
    
    UI.message("ğŸ”¨ Building entire workspace...")
    
    xcodebuild(
      workspace: WORKSPACE_NAME,
      scheme: WORKSPACE_SCHEME,          # "Booket-Workspace" ì‚¬ìš©
      configuration: "Debug",
      build_settings: {
        "CODE_SIGN_IDENTITY" => "",
        "CODE_SIGNING_REQUIRED" => "NO"
      }
    )
    
    UI.success("âœ… Workspace build completed!")
  end

  desc "Quick validation - build modules and test"
  lane :validate do
    UI.message("ğŸ” Running full validation...")
    
    # 1. ëª¨ë“ˆë“¤ ë¹Œë“œ
    build_modules
    
    # 2. ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    test_modules
    
    # 3. ë©”ì¸ ì•± ë¹Œë“œ (ê°œë°œìš©)
    build_dev
    
    UI.success("âœ… Full validation completed!")
  end

  desc "Build and upload to TestFlight (ë‚˜ì¤‘ì— í•„ìš”ì‹œ ì‚¬ìš©)"
  lane :beta do
    UI.message("âŒ TestFlight upload is not configured yet")
    UI.message("ğŸ’¡ Use 'build_dev' for development builds")
    UI.message("ğŸ“ To configure TestFlight, you need:")
    UI.message("  - Apple Distribution certificate")
    UI.message("  - App Store Connect access")
    UI.message("  - App Store provisioning profile")
  end

  desc "Clean everything"
  lane :clean do
    UI.message("ğŸ§¹ Cleaning...")
    
    # Tuist ìºì‹œ ì •ë¦¬
    sh("cd .. && tuist clean")
    
    # ë¹Œë“œ ê²°ê³¼ë¬¼ ì •ë¦¬
    sh("rm -rf ./builds/")
    sh("rm -rf ./test_output/")
    
    # Xcode íŒŒìƒ ë°ì´í„° ì •ë¦¬ (ì„ íƒì‚¬í•­)
    # sh("rm -rf ~/Library/Developer/Xcode/DerivedData/Booket-*")
    
    UI.success("âœ… Clean completed!")
  end

  desc "Show project info"
  lane :info do
    generate
    
    UI.header("ğŸ“± Booket Project Information")
    
    UI.message("Workspace: #{WORKSPACE_NAME}")
    UI.message("Main App Scheme: #{MAIN_APP_SCHEME}")
    UI.message("Bundle ID: #{BUNDLE_ID}")
    UI.message("Team ID: #{TEAM_ID}")
    UI.message("Apple ID: #{APPLE_ID || 'Not set'}")
    
    UI.message("\nğŸ”§ Environment Variables:")
    UI.message("  - DEVELOPMENT_TEAM: #{ENV['DEVELOPMENT_TEAM'] || 'Using default'}")
    UI.message("  - APP_IDENTIFIER: #{ENV['APP_IDENTIFIER'] || 'Using default'}")
    UI.message("  - APPLE_ID: #{ENV['APPLE_ID'] || 'Not set'}")
    
    UI.message("\nğŸ“¦ Module Schemes:")
    MODULE_SCHEMES.each { |scheme| UI.message("  - #{scheme}") }
    
    UI.message("\nğŸ§ª Test Schemes:")
    TEST_SCHEMES.each { |scheme| UI.message("  - #{scheme}") }
    
    UI.message("\nğŸ“‹ All Available Schemes:")
    sh("xcodebuild -workspace ../#{WORKSPACE_NAME} -list")
  end

  # ì—ëŸ¬ ì²˜ë¦¬
  error do |lane, exception|
    UI.error("âŒ Lane '#{lane}' failed: #{exception.message}")
  end
end